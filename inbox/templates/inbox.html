{% load static %}
{% load dict_filters %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inbox - Chat </title>
  <link rel="stylesheet" href="{% static 'css/inbox.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
  <style>
    
  </style>
</head>
<body>
  <div class="sidebar">
    <a href="{% url 'home:index' %}" class="btn btn-primary" style="color: white; text-decoration: none;">Back</a>
    
    <div class="search-box">
      <input type="text" placeholder="Search chats...">
    </div>
    <div class="user">
      <img src="{% if user_profile.profile_pic %}{{ user_profile.profile_pic.url }}{% else %}{% static 'images/default-profile.png' %}{% endif %}" alt="">
      <div class="info">
        <h4>{{user.username}}</h4>
        <p>Active now</p>
      </div>
      <div class="online-dot"></div>
    </div>
    {% for followed_user in followings %}
  <a href="{% url 'inbox' followed_user.user.username %}">
    <div class="user">
      <img src="{% if followed_user.profile_pic %}{{ followed_user.profile_pic.url }}{% else %}{% static 'images/default-profile.png' %}{% endif %}" alt="profile">
      <div class="info">
        <h4>{{followed_user.user.username}}</h4>    
        <p>15h ago</p>
      </div>
    </div>
    {% empty %}
    <p>no users followed</p>
    {% endfor   %}
  </a>
    <!-- Add more users here -->
  </div>


  <div class="chat-section">
    <div class="chat-header">
      {% if selected_user %}
      <img src="{% if selected_user.userprofile.profile_pic %}{{ selected_user.userprofile.profile_pic.url }}{% else %}{% static 'images/default-profile.png' %}{% endif %}" alt="default">
      <div>
        <h4 style="margin: 0; color: #fff;">{{selected_user.username}}</h4>
        <small style="color: #aaa;">Active now</small>
      </div>
      {% else %}
      <p>select a user to start chatting</p>
      {% endif %}
    </div>

<div class="chat-messages">
 {% for msg in messages %}
  <div class="message {% if msg.sender == user %}sent{% else %}received{% endif %}">

    {% if msg.context and '/post/' in msg.context %}
      {% with msg.context|split:"/post/" as context_parts %}
        {% if context_parts.1 %}
          {% with post_id=context_parts.1 %}
        {% with shared_post=shared_posts_dict|get_item:post_id %}
        {% if shared_post %}
          <div class="shared-post">
            <a href="{% url 'home:post_detail' shared_post.id %}">
              {% if shared_post.is_image %}
                <img src="{{ shared_post.image_video.url }}" alt="Post Image" width="200">
              {% elif shared_post.is_video %}
                <video width="200" controls>
                  <source src="{{ shared_post.image_video.url }}" type="video/mp4">
                  Your browser does not support the video tag.
                </video>
              {% else %}
                <p>No media available for this post</p>
              {% endif %}
              <p>{{ shared_post.description }}</p>
            </a>
          </div>
        {% else %}
          <p>Post not found for ID: {{ post_id }}</p>
        {% endif %}
      {% endwith %}

          {% endwith %}
        {% else %}
          <p>Error: Post ID could not be parsed from context: {{ msg.context }}</p>
        {% endif %}
      {% endwith %}
    {% else %}
      <p>{{ msg.content }}</p>
    {% endif %}
    
    <small>{{ msg.timestamp }}</small>
  </div>
{% endfor %}
</div>
    <div class="chat-input">
      <form action="" method="POST">
        {% csrf_token %}
      <input type="text" placeholder="Type a message... "  name="content" value="{{ form.content.value }}">
      <button type="submit"><i class="fa-solid fa-paper-plane"></i></button>
      </form>
    </div>
  </div>
</body>
</html>